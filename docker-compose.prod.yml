version: '3.7'
services:
  express:
    build:
      context: ./server/.
      args:
        EXPRESS_PORT: ${EXPRESS_DOCKER_PORT}
        SESSION_NAME: ${SESSION_NAME}
        SESSION_SECRET: ${SESSION_SECRET}
        KEYCLOAK_PORT: ${KEYCLOAK_PORT}
        KEYCLOAK_CLIENT_ID: ${KEYCLOAK_CLIENT_ID}
        KEYCLOAK_REALM: ${KEYCLOAK_REALM}
        KEYCLOAK_CLIENT_SECRET: ${KEYCLOAK_CLIENT_SECRET}
        AUTH_SERVER_URL: "http://keycloak:${KEYCLOAK_DOCKER_PORT}/auth"
        AUTH_CALLBACK_URL: ${AUTH_CALLBACK_URL}
        APP_BASE_URL: ${APP_BASE_URL}
        HASURA_SECRET: ${HASURA_SECRET}
        NGINX_PORT: ${NGINX_PORT}
        REDIS_HOST: redis
        REDIS_PORT: ${REDIS_DOCKER_PORT}
        DOCKER_HOST_IP: ${DOCKER_HOST_IP}
        GRAPHQL_END_POINT: "http://hasura:${HASURA_DOCKER_PORT}/v1/graphql"
    restart: unless-stopped
  nginx:
    volumes:
      - ./build/spa:/www
      - ./data/certbot/conf:/etc/letsencrypt
      - ./data/certbot/www:/var/www/certbot
    ports:
      - 80:80
      - 443:443
    command: "/bin/sh -c 'while :; do sleep 6h & wait $${!}; nginx -s reload; done & nginx -g \"daemon off;\"'"
  certbot:
    image: certbot/certbot
    restart: unless-stopped
    volumes:
      - ./build/certbot/conf:/etc/letsencrypt
      - ./build/certbot/www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
  redis:
    ports: []
  hasura:
    environment:
      HASURA_GRAPHQL_AUTH_HOOK: http://express:${EXPRESS_DOCKER_PORT}/${HASURA_WEBHOOK}
