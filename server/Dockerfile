FROM node:15.5.0
WORKDIR /app
COPY package.json /app
RUN npm install
COPY . /app

ARG EXPRESS_PORT
ARG SESSION_NAME
ARG SESSION_SECRET
ARG KEYCLOAK_PORT
ARG KEYCLOAK_CLIENT_ID
ARG KEYCLOAK_REALM
ARG KEYCLOAK_CLIENT_SECRET
ARG AUTH_SERVER_URL
ARG AUTH_CALLBACK_URL
ARG APP_BASE_URL
ARG HASURA_SECRET
ARG NGINX_PORT
ARG REDIS_HOST
ARG REDIS_PORT
ARG DOCKER_HOST_IP

ENV EXPRESS_PORT $EXPRESS_PORT
ENV SESSION_NAME $SESSION_NAME
ENV SESSION_SECRET $SESSION_SECRET
ENV KEYCLOAK_PORT $KEYCLOAK_PORT
ENV KEYCLOAK_CLIENT_ID $KEYCLOAK_CLIENT_ID
ENV KEYCLOAK_REALM $KEYCLOAK_REALM
ENV KEYCLOAK_CLIENT_SECRET $KEYCLOAK_CLIENT_SECRET
ENV AUTH_SERVER_URL $AUTH_SERVER_URL
ENV AUTH_CALLBACK_URL $AUTH_CALLBACK_URL
ENV APP_BASE_URL $APP_BASE_URL
ENV HASURA_SECRET $HASURA_SECRET
ENV NGINX_PORT $NGINX_PORT
ENV REDIS_HOST $REDIS_HOST
ENV REDIS_PORT $REDIS_PORT
ENV DOCKER_HOST_IP $DOCKER_HOST_IP

RUN npm run compile
CMD npm run start-compiled
EXPOSE $EXPRESS_PORT